<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .navbar-custom {
            background-color: #401a64 !important;

            .nav-link {
                color: white;
            }
        }

        main {
            h1 {
                width: 100%;
                margin: 0 20px;
            }

            h3 {
                width: 100%;
                margin: 20px;
            }

            #gestor {
                display: grid;
                grid-template-columns: 1fr 1fr;
                padding: 20px;
                place-content: center;

                #formularioProfesorsHandler,
                #formulariEstudiantesHandler {
                    margin-top: 20px;
                    display: grid;
                    grid-template-columns: 150px 300px;
                    place-content: center;
                    gap: 10px;



                    .table {
                        width: 85%;
                        max-width: 90%;
                        margin: 0 auto;

                    }
                }

                .btns-Profesor,
                .btns-Estudiante {
                    margin-top: 20px;
                    display: flex;
                    justify-content: center;
                    gap: 12px;
                }

                .cursos {
                    grid-column: span 2;
                    margin: 40px 0;

                    .interactividad {
                        h1 {
                            width: auto;
                        }

                        display: flex;
                        gap: 40px;
                        justify-content: center;
                    }

                    table {
                        width: 50%;
                    }
                }


            }

        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary navbar-custom">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="logOut" href="#">Log out</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <main>
        <div id="bienvenida">
            <h1>bienvenido director: </h1>
        </div>

        <div id="gestor">
            <div class="agregarProfesorForm">
                <h1 class="text-center">Gestion de Profesor</h1>
                <form id="formularioProfesorsHandler" class="row">
                    <!-- <label for="codigoProfesor">Codigo :</label>
                    <input type="text" id="codigoProfesor" disabled> -->
                    <label for="correoProfesor">Correo :</label>
                    <input type="text" id="correoProfesor">
                    <label for="NombresProfesor">nombres profesor:</label>
                    <input type="text" id="NombresProfesor">
                    <label for="apellidosProfesor">apellidos profesor:</label>
                    <input type="text" id="apellidosProfesor">
                    <label for="contrasenaProfesor">contrasena:</label>
                    <input type="password" id="contrasenaProfesor" disabled placeholder="12345">

                    <!-- <label for="cantidadAlumno">cursos totales:</label>
                    <input type="text" id="cantidadAlumno" disabled> -->

                    <!-- <label for="ComboxCursos">Tus Actividades:</label>
                    <select class="form-control" id="ComboxCursos">
                        <option value="">Selecciona una opción</option>
                    </select> -->
                </form>
            </div>
            <div class="agregarAlumnoForm">
                <h1 class="text-center">Gestion de Alumnos</h1>
                <form id="formulariEstudiantesHandler" class="row">
                    <!-- <label for="codigoAlumno">Codigo :</label>
                    <input type="text" id="codigoAlumno" disabled> -->
                    <label for="correoAlumno">Correo :</label>
                    <input type="text" id="correoAlumno">
                    <label for="nombresAlumno">Alumno nombres:</label>
                    <input type="text" id="nombresAlumno">
                    <label for="apellidosAlumno">Alumno apellidos:</label>
                    <input type="text" id="apellidosAlumno">
                    <label for="contrasenaAlumno">Alumno contraseña:</label>
                    <input type="text" id="contrasenaAlumno" disabled placeholder="12345">
                    <!-- <label for="cantidadCursos">cursos inscritos:</label>
                    <input type="text" id="cantidadCursos" disabled> -->
                    <!-- <label for="ComboxCursos">Tus Actividades:</label>
                    <select class="form-control" id="ComboxCursos"> -->
                        <!-- <option value="">Selecciona una opción</option>
                    </select> -->
                </form>
            </div>
            <div class="btns-Profesor">
                <button type="button" id="btnAgregarpROFESOR" class="btn btn-secondary btn-limited btn-custom">CREAR
                    PROFESOR</button>
                <!-- <button type="button" id="btnBuscarProfesor"
                    class="btn btn-secondary btn-limited btn-custom">BUSCAR</button> -->
                <!-- <button type="button" id="btnMatricularProfesor"
                    class="btn btn-secondary btn-limited btn-custom">CONTRATAR</button>
                <button type="button" id="btnEliminarProfesor"
                    class="btn btn-secondary btn-limited btn-custom">ELIMINAR</button> -->
                <button type="button" id="btnLimpiarProfesor"
                    class="btn btn-secondary btn-limited btn-custom">LIMPIAR</button>
            </div>
            <div class="btns-Estudiante">
                <button type="button" id="btnAgregarEstudiante" class="btn btn-secondary btn-limited btn-custom">CREAR
                    ESTUDIANTE </button>
                <button type="button" id="btnBuscarEstudiante"
                    class="btn btn-secondary btn-limited btn-custom">BUSCAR</button>
                <!-- <button type="button" id="btnEliminaEstudiante"
                    class="btn btn-secondary btn-limited btn-custom">ELIMINAR</button>
                <button type="button" id="btnModificarEstudiante"
                    class="btn btn-secondary btn-limited btn-custom">MODIFICAR</button> -->
                <button type="button" id="btnLimpiarCurso"
                    class="btn btn-secondary btn-limited btn-custom">LIMPIAR</button>
            </div>

            <div class="cursos">
                <div class="interactividad">
                    <h1>Cursos</h1>
                    <button id="btnImprimir" type="button"
                        class="btn btn-secondary btn-limited btn-custom">IMPRIMIR</button>
                </div>

                <table class="table table-resposive table-bordered table-hover table-striped mx-auto">
                    <thead>
                        <tr id="infoEncabezados" class="table-active">

                        </tr>
                    </thead>
                    <tbody id="CuerpoTable">

                    </tbody>
                </table>
            </div>
    </main>

    <script>
        //componente director
        const bienvenida = document.getElementById('bienvenida')
        //otros 
        let idDirector;
        let nombreDirector;
        const accessToken = localStorage.getItem("accessToken");
        const refreshToken = localStorage.getItem("refreshToken");
        const logOut = document.getElementById('logOut')

        //table
        const infoCuerpoTable = document.getElementById('CuerpoTable')
        const infoEncabezados = document.getElementById('infoEncabezados')
        const btnImprimir = document.getElementById('btnImprimir')

        //    // Componentes del formulario de Profesor
        const codigoProfesorInput = document.getElementById('codigoProfesor');
        const correoProfesorInput = document.getElementById('correoProfesor');
        const nombresProfesorInput = document.getElementById('NombresProfesor');
        const apellidosProfesor = document.getElementById('apellidosProfesor');
        const contrasenaProfesor = document.getElementById('contrasenaProfesor');
        const cantidadAlumnoInput = document.getElementById('cantidadAlumno');
        const comboxCursosProfesor = document.getElementById('ComboxCursos');

        // Componentes del formulario de Estudiante
        const codigoAlumnoInput = document.getElementById('codigoAlumno');
        const correoAlumnoInput = document.getElementById('correoAlumno');
        const nombresAlumnoInput = document.getElementById('nombresAlumno');
        const apellidosAlumnoInput = document.getElementById('apellidosAlumno');
        const contrasenaAlumnoInput = document.getElementById('contrasenaAlumno');
        const cantidadCursosInput = document.getElementById('cantidadCursos');
        const comboxCursosAlumno = document.getElementById('ComboxCursos'); // Select del Estudiante

        // Botones de Profesor
        const btnCrearProfesor = document.getElementById('btnAgregarpROFESOR');
        const btnBuscarProfesor = document.getElementById('btnBuscarProfesor');
        const btnMatricularProfesor = document.getElementById('btnMatricularProfesor');
        const btnEliminarProfesor = document.getElementById('btnEliminarProfesor');
        const btnLimpiarProfesor = document.getElementById('btnLimpiarProfesor');

        // Botones de Estudiante
        const btnCrearEstudiante = document.getElementById('btnAgregarEstudiante');
        const btnBuscarEstudiante = document.getElementById('btnBuscarEstudiante');
        const btnEliminarEstudiante = document.getElementById('btnEliminaEstudiante');
        const btnModificarEstudiante = document.getElementById('btnModificarEstudiante');
        const btnLimpiarEstudiante = document.getElementById('btnLimpiarCurso');


        document.addEventListener('DOMContentLoaded', async (e) => {
            if (accessToken == null && refreshToken == null) {
                alert("no tienes permiso")
                window.location.href = "./"
                return
            }

            try {
                const response = await fetch(`http://localhost:3000/api/public/permiso`, {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json',
                        'AccessToken': accessToken,
                        'RefreshToken': refreshToken
                    }
                });
                
                if (response.ok) {
                    await buscarInfoDirector();
                    await buscarCursos();
                } else {
                    alert("no tienes permiso")
                    window.location.href = "./"
                    console.log(response);
                }
            } catch (error) {
                alert("ha ocurrido un error")
                console.log(error);
                window.location.href = "./"
            }

        });

        const buscarInfoDirector = async () => {
            try {
                const response = await fetch(`http://localhost:3000/api/public/usuariobyToken`, {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json',
                        'AccessToken': accessToken,
                        'RefreshToken': refreshToken
                    }
                });

                if (response.ok) {
                    const director = await response.json();
                    if (director) {
                        idDirector = director._id;
                        nombreDirector = `${director.nombres} ${director.apellidos}`;
                        bienvenida.innerHTML = `
                            <h3>Bienvenido director: ${nombreDirector}</h3>
                        `;
                    }
                } else {
                    alert("No se encontró al director");
                }
            } catch (error) {
                console.log(error);
            }
        };

        const buscarCursos = async () => {
            let bodyTabla = ''
            let encabezados = `<th>Nombre del curso</th>
                            <th>codigo</th>
                            <th>profesor</th>
                            <th>alumno inscritos</th>`
            try {
                const response = await fetch(`http://localhost:3000/api/public/cursos`, {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json',
                        'AccessToken': accessToken,
                        'RefreshToken': refreshToken
                    }
                });

                if (response.ok) {
                    const cursos = await response.json();
                    console.log(cursos);
                    cursos.forEach(c => {
                        bodyTabla += `<tr>
                            <th>${c.nombre}</th>
                            <th>${c.profesor}</th>
                            <th>${c.nombreProfesor}</th>
                            <th>${c.alumnos}</th>
                        </tr>`
                    });
                    infoEncabezados.innerHTML = encabezados
                    infoCuerpoTable.innerHTML = bodyTabla;
                } else {
                    alert("No hat curso");
                }
            } catch (error) {
                console.log(error);
            }

            btnImprimir.addEventListener('click', async () => {
                try {
                    const response = await fetch(`http://localhost:3000/api/public/generarReporte/director`, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                            'AccessToken': accessToken,
                            'RefreshToken': refreshToken
                        },
                        body: JSON.stringify({
                            encabezados: encabezados,
                            cuerpo: bodyTabla,
                            nombreDirector: `${nombreDirector}`,
                        })
                    });

                    if (response.ok) {
                        // Convertir la respuesta en un Blob (objeto binario)
                        const blob = await response.blob();

                        // Crear un enlace (link) para descargar el PDF
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'reporte.pdf'; // Nombre del archivo para descargar
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        alert("reporte generado")
                    } else {
                        // Mostrar un mensaje de error si la solicitud no fue exitosa
                        alert("No se pudo realizar el reporte");
                    }
                } catch (error) {
                    console.log(error);
                }
            })
        }


        btnCrearProfesor.addEventListener('click', async () => {
            const nombres = nombresProfesorInput.value
            const apellidos = apellidosProfesor.value
            const correo = correoProfesorInput.value
            const contrasena = "12345"
            try {
                const response = await fetch(`http://localhost:3000/api/public/registro`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'AccessToken': accessToken,
                        'RefreshToken': refreshToken
                    },
                    body: JSON.stringify({
                        "nombres": nombres,
                        "apellidos": apellidos,
                        "correo": correo,
                        "contrasena": contrasena,
                        "role": "maestro"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert("profesor creado exitosamente")
                    console.log(data);
                } else {
                    alert("No se pudo crear al profesor");
                }
            } catch (error) {
                console.log(error);
            }
        })
        btnCrearEstudiante.addEventListener('click', async () => {
            const nombres = nombresAlumnoInput.value
            const apellidos = apellidosAlumnoInput.value
            const correo = correoAlumnoInput.value
            const contrasena = contrasenaAlumnoInput.value
            try {
                const response = await fetch(`http://localhost:3000/api/public/registro`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'AccessToken': accessToken,
                        'RefreshToken': refreshToken
                    },
                    body: JSON.stringify({
                        "nombres": nombres,
                        "apellidos": apellidos,
                        "correo": correo,
                        "contrasena": "12345",
                        "role": "estudiante"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert("estudiante creado exitosamente")
                    console.log(data);
                } else {
                    alert("No se pudo crear al estudiante");
                }
            } catch (error) {
                console.log(error);
            }
        })
        btnLimpiarEstudiante.addEventListener('click', () => {
            codigoAlumnoInput.value = ''
        })

        btnImprimir.addEventListener('click', () => {
            console.log('imprimiendo');
        })

        logOut.addEventListener('click', (e) => {
            e.preventDefault()
            // Eliminar un elemento del localStorage
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');

            alert("sesion cerrada")
            window.location.href = "./"
        })

        // Función para limpiar campos del formulario de Profesor
        const limpiarCamposProfesor = () => {
            codigoProfesorInput.value = '';
            correoProfesorInput.value = '';
            apellidosProfesor.value = '';
            contrasenaProfesor.value = '';
            cantidadAlumnoInput.value = '';
        };

        // Función para limpiar campos del formulario de Estudiante
        const limpiarCamposEstudiante = () => {
            codigoAlumnoInput.value = '';
            correoAlumnoInput.value = '';
            nombresAlumnoInput.value = '';
            apellidosAlumnoInput.value = '';
            contrasenaAlumnoInput.value = '';
            codigoAlumnoInput.value = '';
        };
        
        
        // Evento al hacer clic en el botón Limpiar Profesor
        btnLimpiarProfesor.addEventListener('click', () => {
            limpiarCamposProfesor();
        });

        // Evento al hacer clic en el botón Limpiar Estudiante
        btnLimpiarEstudiante.addEventListener('click', () => {
            limpiarCamposEstudiante();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>


</body>

</html>